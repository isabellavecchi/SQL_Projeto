CREATE DATABASE Old_Dragon;

CREATE TABLE tb_personagem(
	personagem		VARCHAR(62)	CONSTRAINT pk_personagem	PRIMARY KEY,
	jogador			VARCHAR(62)	CONSTRAINT nn_jogador		NOT NULL,
	raca			VARCHAR(32)	CONSTRAINT nn_raca			NOT NULL,
	classe			VARCHAR(32)	CONSTRAINT nn_classe		NOT NULL,
	nivel			INTEGER		CONSTRAINT nn_nivel			NOT NULL,
	alinhamento		VARCHAR(32)	CONSTRAINT nn_alinhamento	NOT NULL,
	xp				INTEGER,
	base_ataque		INTEGER,
	jogada_protecao	INTEGER,
	CONSTRAINT fk_raca 	FOREIGN KEY(raca)
		REFERENCES tb_raca(raca),
	CONSTRAINT fk_classe FOREIGN KEY(classe)
		REFERENCES tb_classe(classe)
);

-- Role 4 sequências de d6, seis vezes, e insira os resultados nesta tabela
CREATE TABLE tb_dados(
	personagem	VARCHAR(62)	CONSTRAINT nn_jogador	NOT NULL,
	seq			INTEGER		CONSTRAINT nn_seq		NOT NULL,
	dado_1		INTEGER		CONSTRAINT nn_dado_1	NOT NULL,
	dado_2		INTEGER		CONSTRAINT nn_dado_2	NOT NULL,
	dado_3		INTEGER		CONSTRAINT nn_dado_3	NOT NULL,
	dado_4		INTEGER		CONSTRAINT nn_dado_4	NOT NULL
);
DROP TABLE tb_dados

SELECT * FROM tb_dados

INSERT INTO tb_dados
VALUES('isabella',1,4,3,6,5),
('isabella',2,6,5,4,3),
('isabella',3,4,5,2,3),
('isabella',4,6,6,2,5),
('isabella',5,4,5,6,5),
('isabella',6,6,6,2,1);


CREATE TABLE tb_atributos(
	personagem			VARCHAR(62)	CONSTRAINT nn_personagem		NOT NULL,	
	nome_atributo		VARCHAR(32)	CONSTRAINT nn_nome_atributo		NOT NULL,
	valor_atributo		INTEGER		CONSTRAINT nn_valor_atributo	NOT NULL,
	mod_atributo		INTEGER		CONSTRAINT nn_mod_atributo		NOT NULL
);
DROP TABLE tb_atributos

CREATE OR REPLACE FUNCTION fn_valores_para_atributo(
	v_personagem	VARCHAR(64))
RETURNS varchar AS
$$
DECLARE
	v_seq		tb_dados.seq%TYPE;
	menor_valor	INTEGER;
	soma		INTEGER;
	atributos	INTEGER[6];
BEGIN
	v_seq :=0;
	LOOP
	EXIT WHEN v_seq > 6;
		soma:= 0;
		menor_valor:= 0;
		v_seq := v_seq +1;
		SELECT LEAST(dado_1,dado_2,dado_3,dado_4)
		INTO menor_valor
		FROM tb_dados
		WHERE seq = v_seq AND personagem = v_personagem;
		
		SELECT dado_1 + dado_2 + dado_3 + dado_4
		INTO soma
		FROM tb_dados
		WHERE seq = v_seq;
		
		soma := soma - menor_valor;
		atributos[v_seq] := soma;
	END LOOP;
	Return 'Os valores de atributo para o Personagem: '||v_personagem||' são : ['||atributos[1]||', '||atributos[2]||
	', '||atributos[3]||', '||atributos[4]||', '||atributos[5]||', '||atributos[6]||'].';
END
$$
LANGUAGE plpgsql;

SELECT fn_valores_para_atributo('isabella')

-- FUNÇÃO INSERIR VALORES NA TABELA ATRIBUTOS
CREATE OR REPLACE FUNCTION fn_inserir_atributos(
	v_personagem	VARCHAR(64),
	v_forca			INTEGER,
	v_inteligencia	INTEGER,
	v_sabedoria		INTEGER,
	v_destreza		INTEGER,
	v_constituicao	INTEGER,
	v_carisma		INTEGER)
RETURNS varchar AS
$$
DECLARE
	v_mod_forca			INTEGER;
	v_mod_inteligencia	INTEGER;
	v_mod_sabedoria		INTEGER;
	v_mod_destreza		INTEGER;
	v_mod_constituicao	INTEGER;
	v_mod_carisma		INTEGER;
BEGIN	
	v_mod_forca			:= FLOOR((v_forca - 10)/2);
	v_mod_inteligencia	:= FLOOR((v_inteligencia - 10)/2);
	v_mod_sabedoria		:= FLOOR((v_sabedoria - 10)/2);
	v_mod_destreza		:= FLOOR((v_destreza - 10)/2);
	v_mod_constituicao	:= FLOOR((v_constituicao - 10)/2);
	v_mod_carisma		:= FLOOR((v_carisma - 10)/2);
	
	INSERT INTO tb_atributos
	VALUES(v_personagem,'forca',v_forca,v_mod_forca),
		(v_personagem,'inteligencia',v_inteligencia,v_mod_inteligencia),
		(v_personagem,'sabedoria',v_sabedoria,v_mod_sabedoria),
		(v_personagem,'destreza',v_destreza,v_mod_destreza),
		(v_personagem,'constituicao',v_constituicao,v_mod_constituicao),
		(v_personagem,'carisma',v_carisma,v_mod_carisma);	
	RETURN 'é isso aí';
END
$$
LANGUAGE plpgsql;

Select fn_inserir_atributos('isabella',15,12,17,15,14,16)

SELECT * FROM tb_atributos

--3o passo

CREATE TABLE tb_raca(
	raca				VARCHAR(32)	CONSTRAINT pk_raca		PRIMARY KEY,
	dado_de_vida		INTEGER		CONSTRAINT nn_vida		NOT NULL,
	modificador_mais	VARCHAR(32)	CONSTRAINT nn_mod_mais	NOT NULL,
	modificador_menos	VARCHAR(32)	CONSTRAINT nn_mod_menos	NOT NULL,
	altura				VARCHAR(32)	CONSTRAINT nn_altura	NOT NULL,
	peso				VARCHAR(32)	CONSTRAINT nn_peso		NOT NULL,
	maturidade			INTEGER		CONSTRAINT nn_maturid	NOT NULL,
	expec_vida			INTEGER		CONSTRAINT nn_expec_vid	NOT NULL,
	mov_base_metros		INTEGER		CONSTRAINT nn_mov_base	NOT NULL,
	visao_escuro		INTEGER,
	visao_penumbra		INTEGER,
	maos_armas_medias	INTEGER		CONSTRAINT nn_maos_am	NOT NULL,
	maos_armas_grandes	INTEGER		CONSTRAINT nn_maos_ag	NOT NULL
);


INSERT INTO tb_raca VALUES 	('humano',10,'escolha','escolha','1,60 - 1,90 metros','55 - 90 kg',15,70,9,NULL,NULL,1,1),
							('anao',10,'constituicao','carisma','1,30 - 1,50 metros','50 - 70 kg',70,350,6,15,NULL,1,2),
							('elfo',8,'destreza','constituicao','1,50 - 1,70 metros','40 - 50 kg',150,700,9,NULL,50,1,1),
							('halfling',10,'destreza','forca','0,70 - 0,90 metros','20 - 35 kg',30,70,6,NULL,NULL,2,0);
							
CREATE TABLE tb_classe(
	classe			VARCHAR(32)	CONSTRAINT 	  pk_classe		PRIMARY KEY,
	dado_de_vida	INTEGER		CONSTRAINT nn_dado_de_vida	NOT NULL,
	atributo_req_1	VARCHAR(32)	CONSTRAINT nn_atributo_req	NOT NULL,
	atributo_min_1	INTEGER		CONSTRAINT nn_atributo_min	NOT NULL,
	atributo_req_2	VARCHAR(32),
	atributo_min_2	INTEGER
);

INSERT INTO tb_classe VALUES ('clerigo',8,'sabedoria',14,NULL,NULL),
							('homem de arma - nao elfo',10,'forca',12,'constituicao',12),
							('homem de arma - elfo',8,'forca',12,'constituicao',12),
							('mago',4,'inteligencia',14,NULL,NULL),
							('ladrao',6,'destreza',12,NULL,NULL);
							

